{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Plistory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    crossorigin="anonymous" />
</head>

<body class="min-h-screen w-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4"
  style="font-family: 'Noto Sans KR', sans-serif;">

  <div>

    <!-- ìƒë‹¨ ì½˜í…ì¸  -->
    <div class="content space-y-6">

      <!--ì¶”ì²œ íƒ­-->
      <div id="home" class="tab-content">
        {% include "main/includes/rec.html" %}
      </div>

      <!--ê²€ìƒ‰ íƒ­-->
      <div id="search" class="tab-content">
        <div class="mt-10 text-white">
          <h2 class="text-xl font-bold text-center mb-4">ğŸ” í•´ì‹œíƒœê·¸ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰</h2>

          {% include "main/includes/search_hashtag.html" %}

          <div id="playlistResults" class="mt-6"></div>
        </div>

        <script>
          const playlistData = [
            { title: 'ë°¤ ë“œë¼ì´ë¸Œ ìŒì•…', hashtags: ['ë“œë¼ì´ë¸Œ', 'ì‹œí‹°íŒ'] },
            { title: 'ê°ì„± ì”ì” í”Œë ˆì´ë¦¬ìŠ¤íŠ¸', hashtags: ['ê°ì„±ì ì¸', 'ì”ì”í•œ'] },
            { title: 'ìˆ˜ëŠ¥ê¸ˆì§€ê³¡ ëª¨ìŒ', hashtags: ['ìˆ˜ëŠ¥ê¸ˆì§€ê³¡'] },
            { title: 'ì¹´í˜ ë¶„ìœ„ê¸° ìŒì•…', hashtags: ['ì¹´í˜ë¶„ìœ„ê¸°'] }
          ];

          document.querySelectorAll('.tag').forEach(tagEl => {
            tagEl.addEventListener('click', () => {
              const clickedTag = tagEl.textContent.trim().replace('#', '');
              const filtered = playlistData.filter(p => p.hashtags.includes(clickedTag));
              const resultDiv = document.getElementById('playlistResults');
              resultDiv.innerHTML = filtered.length
                ? '<ul>' + filtered.map(p => `<li class="my-2">ğŸµ ${p.title}</li>`).join('') + '</ul>'
                : '<p class="mt-4 text-center">í•´ë‹¹ í•´ì‹œíƒœê·¸ê°€ í¬í•¨ëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
          });
        </script>
      </div>

      <!--í”Œë¦¬ ìƒì„± íƒ­-->
      <div id="add" class="tab-content">
        {% include "main/includes/playlist_content.html" %}
      </div>

      <!--í”„ë¡œí•„ íƒ­-->
      <div id="profile" class="tab-content">
        {% include "main/includes/profile_section.html" with profile_user=request.user is_own_profile=True %}
      </div>


      <!-- í•˜ë‹¨ íƒ­ -->
      <div class="fixed bottom-0 left-0 right-0 flex h-16 z-50">
        <button onclick="showTab('home')"
          class="tab-btn w-1/4 flex justify-center items-center bg-transparent border-none outline-none focus:outline-none active:bg-transparent appearance-none">
          <img src="{% static 'icons/home.png' %}" alt="Home" class="tab-icon w-8 h-8">
        </button>
        <button onclick="showTab('search')"
          class="tab-btn w-1/4 flex justify-center items-center bg-transparent border-none outline-none focus:outline-none active:bg-transparent appearance-none">
          <img src="{% static 'icons/search.png' %}" alt="Search" class="tab-icon w-9 h-9">
        </button>
        <button onclick="showTab('add')" class="tab-btn w-1/4 flex justify-center items-center">
          <img src="{% static 'icons/add.png' %}" alt="Add" class="tab-icon w-9 h-9">
        </button>
        <button onclick="showTab('profile')"
          class="tab-btn w-1/4 flex justify-center items-center bg-transparent border-none outline-none focus:outline-none active:bg-transparent appearance-none">
          <img src="{% static 'icons/profile.png' %}" alt="Profile" class="tab-icon w-8 h-8">
        </button>
      </div>



      <!--í”Œë¦¬ ìƒì„± íƒ­ - ë…¸ë˜ ì¶”ê°€ -->
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const selectButton = document.getElementById('selectButton');
          const dropdownMenu = document.getElementById('dropdownMenu');
          const searchInput = document.getElementById('searchInput');
          const optionsList = document.getElementById('optionsList');
          const selectedText = document.getElementById('selectedText');
          const selectArrow = document.getElementById('selectArrow');
          const playlistBox = document.getElementById('playlistBox');
          const form = document.getElementById("tasteForm");
          const playlistInput = document.getElementById("playlistData");
          const checkboxes = document.querySelectorAll('input[type="checkbox"][name="hashtags"]');
          const tags = document.querySelectorAll(".tag");

          // ê³¡ ëª©ë¡ ì „ì—­ ë³€ìˆ˜
          window.playlist = [];

          const options = [
            { id: 1, title: 'ë…¸ë˜ ì œëª© A', artist: 'ì•„í‹°ìŠ¤íŠ¸ A' },
            { id: 2, title: 'ë…¸ë˜ ì œëª© B', artist: 'ì•„í‹°ìŠ¤íŠ¸ B' },
            { id: 3, title: 'ë…¸ë˜ ì œëª© C', artist: 'ì•„í‹°ìŠ¤íŠ¸ C' }
          ];

          // ë“œë¡­ë‹¤ìš´ ê´€ë ¨
          selectButton.addEventListener('click', () => {
            const isHidden = dropdownMenu.classList.contains('hidden');
            dropdownMenu.classList.toggle('hidden');
            selectArrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            if (!isHidden) searchInput.value = '';
            renderOptions(options);
          });

          document.addEventListener('click', (e) => {
            if (!e.target.closest('#searchableSelect')) {
              dropdownMenu.classList.add('hidden');
              selectArrow.style.transform = 'rotate(0deg)';
            }
          });

          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = options.filter(o =>
              o.title.toLowerCase().includes(searchTerm) ||
              o.artist.toLowerCase().includes(searchTerm)
            );
            renderOptions(filtered);
          });

          function renderOptions(filteredOptions) {
            optionsList.innerHTML = '';
            filteredOptions.forEach(opt => {
              const li = document.createElement('li');
              li.className = 'px-4 py-2 hover:bg-white/10 cursor-pointer';
              li.innerHTML = `
          <div class="flex items-center space-x-2.5">
            <img src="https://cdn.startupful.io/img/app_logo/no_img.png" alt="ì•¨ë²” ì•„íŠ¸" class="h-10 w-10 rounded-lg object-cover">
            <div>
              <p class="text-sm font-medium text-white">${opt.title}</p>
              <p class="text-xs text-gray-300">${opt.artist}</p>
            </div>
          </div>
        `;
              li.addEventListener('click', () => {
                selectedText.textContent = opt.title;
                dropdownMenu.classList.add('hidden');
                selectArrow.style.transform = 'rotate(0deg)';
                addToPlaylist(opt);
              });
              optionsList.appendChild(li);
            });
          }

          function addToPlaylist(opt) {
            const playlist = window.playlist;
            if (playlist.length >= 10) {
              alert('ìµœëŒ€ 10ê³¡ê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              return;
            }
            if (playlist.find(item => item.title === opt.title && item.artist === opt.artist)) {
              alert('ì´ë¯¸ ì¶”ê°€ëœ ê³¡ì…ë‹ˆë‹¤.');
              return;
            }

            playlist.push(opt);

            const li = document.createElement('li');
            li.className = 'bg-gray-200/25 p-2 rounded-lg flex items-center space-x-2';
            li.innerHTML = `
        <img src="https://cdn.startupful.io/img/app_logo/no_img.png" class="h-10 w-10 rounded-lg object-cover" alt="ì•¨ë²” ì•„íŠ¸">
        <div>
          <h3 class="text-sm font-semibold">${opt.title}</h3>
          <p class="text-xs text-gray-200">${opt.artist}</p>
        </div>
      `;
            playlistBox.appendChild(li);
          }

          // í•´ì‹œíƒœê·¸ í† ê¸€
          tags.forEach((tag, index) => {
            const checkbox = checkboxes[index];
            const gradient = tag.dataset.gradient.split(" ");
            tag.addEventListener("click", () => {
              const isActive = tag.classList.contains("bg-gradient-to-r");
              tag.classList.remove("bg-white", "bg-opacity-30", "bg-gradient-to-r", ...gradient);
              if (!isActive) {
                tag.classList.add("bg-gradient-to-r", ...gradient);
              } else {
                tag.classList.add("bg-white", "bg-opacity-30");
              }
              checkbox.checked = !isActive;
            });
          });

          // ìœ íš¨ì„± ê²€ì‚¬ + ê³¡ ë°ì´í„° ì „ì†¡
          form.addEventListener("submit", function (e) {
            const selectedHashtags = Array.from(checkboxes).filter(cb => cb.checked).length;
            const songCount = window.playlist.length;

            if (songCount < 3 || selectedHashtags < 3) {
              e.preventDefault();
              let message = "";
              if (songCount < 3) message += "ë…¸ë˜ëŠ” 3ê³¡ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.\n";
              if (selectedHashtags < 3) message += "í•´ì‹œíƒœê·¸ëŠ” 3ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.";
              alert(message);
              return;
            }

            playlistInput.value = JSON.stringify(window.playlist);
          });
        });
      </script>


      <!-- íƒ­ ë²„íŠ¼ -->
      <script>
        function showTab(tabId) {
          // ì½˜í…ì¸  ì „í™˜
          document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
          document.getElementById(tabId).classList.add('active');

          // ì•„ì´ì½˜ ì´ˆê¸°í™”
          document.querySelectorAll('.tab-icon').forEach(img => img.classList.remove('invert'));

          if (event?.currentTarget) {
            event.currentTarget.querySelector('.tab-icon')?.classList.add('invert');
          }
        }
      </script>

      <script>
        function openModal(id) {
          document.getElementById(id).classList.remove('hidden');
          document.getElementById(id).classList.add('flex');
        }
        function closeModal(id) {
          document.getElementById(id).classList.add('hidden');
          document.getElementById(id).classList.remove('flex');
        }
      </script>

      <style>
        .tab-content {
          display: none;
        }

        .tab-content.active {
          display: block;
        }
      </style>

      <!-- íŒ”ë¡œì›Œ ëª¨ë‹¬ -->
      <div id="followersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
        <div class="bg-white w-80 max-h-96 overflow-y-auto rounded-lg p-4">
          <h2 class="text-xl font-semibold mb-3">íŒ”ë¡œì›Œ</h2>
          <ul>
            <li class="py-2 border-b">@follower1</li>
            <li class="py-2 border-b">@follower2</li>
            <li class="py-2 border-b">@follower3</li>
          </ul>
          <button onclick="closeModal('followersModal')"
            class="mt-4 w-full bg-gray-200 hover:bg-gray-300 rounded py-1">ë‹«ê¸°</button>
        </div>
      </div>

      <!-- íŒ”ë¡œì‰ ëª¨ë‹¬ -->
      <div id="followingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
        <div class="bg-white w-80 max-h-96 overflow-y-auto rounded-lg p-4">
          <h2 class="text-xl font-semibold mb-3">íŒ”ë¡œì‰</h2>
          <ul>
            <li class="py-2 border-b">@followee1</li> <!-- ë‚˜ì¤‘ì— ìˆ˜ì • -->
            <li class="py-2 border-b">@followee2</li>
            <li class="py-2 border-b">@followee3</li>
          </ul>
          <button onclick="closeModal('followingModal')"
            class="mt-4 w-full bg-gray-200 hover:bg-gray-300 rounded py-1">ë‹«ê¸°</button>
        </div>
      </div>

      <!--í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ í‘œì‹œ-->
      <script>
        function openPLModal(playlistId) {
          const pl = mockPlaylists[playlistId];
          if (!pl) return;

          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
          modal.innerHTML = `
      <div class="bg-white w-96 max-h-[80vh] overflow-y-auto rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4">${pl.title}</h2>
        <ul class="mb-4">${pl.songs.map(song => `<li class="py-1 border-b">${song}</li>`).join('')}</ul>
        <button onclick="document.body.removeChild(this.parentElement.parentElement)" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 rounded py-2">ë‹«ê¸°</button>
      </div>
    `;
          document.body.appendChild(modal);
        }
      </script>


      <!-- myPL / likedPL-->
      <script>
        function showPLTab(tabId) {
          // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
          document.querySelectorAll('.pl-tab').forEach(tab => {
            tab.classList.add('hidden');
          });

          // ì„ íƒí•œ íƒ­ë§Œ ë³´ì´ê¸°
          document.getElementById(tabId).classList.remove('hidden');
        }
      </script>


      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const urlParams = new URLSearchParams(window.location.search);
          const defaultTabId = urlParams.get('tab') || 'profile';  // ê¸°ë³¸ê°’: profile
          showTab(defaultTabId);

          // ê¸°ë³¸ íƒ­ ë²„íŠ¼ì—ë„ invert íš¨ê³¼ ì ìš©
          const targetBtn = [...document.querySelectorAll('.tab-btn')].find(btn =>
            btn.getAttribute('onclick')?.includes(defaultTabId)
          );
          targetBtn?.querySelector('.tab-icon')?.classList.add('invert');
        });
      </script>

</body>

</html>